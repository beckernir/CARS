<!--<div class="card case-info-card mb-4" th:fragment="case-header(caseReport)">-->
<!--    <div class="card-body">-->
<!--        <div class="row">-->
<!--            <div class="col-md-6">-->
<!--                <h2 class="h4">Case #<span th:text="${caseReport.caseId}">CP-2024-0573</span></h2>-->
<!--                <p class="text-muted mb-0">Reported on: <span th:text="${caseReport.reportDate}">June 3, 2024 at 14:23</span></p>-->
<!--            </div>-->
<!--            <div class="col-md-6 text-md-end">-->
<!--                <div class="d-flex align-items-center justify-content-md-end">-->
<!--                    <span class="status-badge me-2" th:classappend="'status-' + ${caseReport.status}" th:text="${caseReport.status}">Under Investigation</span>-->

<!--                    &lt;!&ndash; Status Change Dropdown &ndash;&gt;-->
<!--                    &lt;!&ndash; Status Change Dropdown &ndash;&gt;-->
<!--                    <div class="dropdown">-->
<!--                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"-->
<!--                                id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">-->
<!--                            Change Status-->
<!--                        </button>-->
<!--                        <ul class="dropdown-menu" aria-labelledby="statusDropdown">-->
<!--                            <li><button class="dropdown-item status-option" type="button" data-status="REPORTED">Reported</button></li>-->
<!--                            <li><button class="dropdown-item status-option" type="button" data-status="ASSIGNED">Assigned</button></li>-->
<!--                            <li><button class="dropdown-item status-option" type="button" data-status="INVESTIGATING">Investigating</button></li>-->
<!--                            <li><button class="dropdown-item status-option" type="button" data-status="RESOLVED">Resolved</button></li>-->
<!--                            <li><button class="dropdown-item status-option" type="button" data-status="CLOSED">Closed</button></li>-->
<!--                        </ul>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--        <hr>-->
<!--        <div class="row">-->
<!--            <div class="col-md-4">-->
<!--            </div>-->
<!--            <div class="col-md-4">-->
<!--                <p class="mb-1"><strong>Location:</strong> <span th:text="${caseReport.locationOfIncident}">1234 Oak Street, Springfield</span></p>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--&lt;!&ndash; Status Change Modal for Confirmation &ndash;&gt;-->
<!--<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">-->
<!--    <div class="modal-dialog">-->
<!--        <div class="modal-content">-->
<!--            <div class="modal-header">-->
<!--                <h5 class="modal-title" id="statusChangeModalLabel">Confirm Status Change</h5>-->
<!--                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--            </div>-->
<!--            <div class="modal-body">-->
<!--                <p>Are you sure you want to change the status of Case #<span id="modalCaseId"></span> to <strong id="modalNewStatus"></strong>?</p>-->
<!--                <div class="mb-3">-->
<!--                    <label for="statusChangeReason" class="form-label">Reason for status change (optional):</label>-->
<!--                    <textarea class="form-control" id="statusChangeReason" rows="3" placeholder="Enter reason for status change..."></textarea>-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>-->
<!--                <button type="button" class="btn btn-primary" id="confirmStatusChange">Confirm Change</button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<script>-->
<!--    document.addEventListener('DOMContentLoaded', function() {-->
<!--        const statusOptions = document.querySelectorAll('.status-option');-->
<!--        const statusBadge = document.querySelector('.status-badge');-->
<!--        const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));-->
<!--        const confirmButton = document.getElementById('confirmStatusChange');-->
<!--        const modalCaseId = document.getElementById('modalCaseId');-->
<!--        const modalNewStatus = document.getElementById('modalNewStatus');-->
<!--        const statusChangeReason = document.getElementById('statusChangeReason');-->

<!--        let selectedStatus = '';-->
<!--        let caseId = '';-->

<!--        // Extract case ID from the page - try multiple selectors-->
<!--        const caseIdElement = document.querySelector('h2.h4 span') ||-->
<!--            document.querySelector('[th\\:text*="caseId"]') ||-->
<!--            document.querySelector('.case-id');-->

<!--        if (caseIdElement) {-->
<!--            caseId = caseIdElement.textContent.trim();-->
<!--            console.log('Extracted case ID:', caseId); // Debug log-->
<!--        } else {-->
<!--            // Try to extract from URL if element not found-->
<!--            const urlMatch = window.location.pathname.match(/\/admin\/view\/(\w+)/);-->
<!--            if (urlMatch) {-->
<!--                caseId = urlMatch[1];-->
<!--                console.log('Extracted case ID from URL:', caseId); // Debug log-->
<!--            }-->
<!--        }-->

<!--        // Handle status option clicks-->
<!--        statusOptions.forEach(option => {-->
<!--            option.addEventListener('click', function(e) {-->
<!--                e.preventDefault(); // Prevent default anchor behavior-->
<!--                e.stopPropagation(); // Stop event bubbling-->

<!--                selectedStatus = this.dataset.status;-->
<!--                const currentStatus = statusBadge.textContent.trim().toUpperCase().replace(/\s+/g, '_');-->

<!--                console.log('Selected status:', selectedStatus); // Debug log-->
<!--                console.log('Current status:', currentStatus); // Debug log-->

<!--                // Don't allow changing to the same status-->
<!--                if (selectedStatus === currentStatus) {-->
<!--                    showAlert('Case is already in ' + selectedStatus.toLowerCase().replace('_', ' ') + ' status.', 'warning');-->
<!--                    return;-->
<!--                }-->

<!--                // Validate we have a case ID-->
<!--                if (!caseId) {-->
<!--                    showAlert('Unable to determine case ID. Please refresh the page and try again.', 'error');-->
<!--                    return;-->
<!--                }-->

<!--                // Show confirmation modal-->
<!--                modalCaseId.textContent = caseId;-->
<!--                modalNewStatus.textContent = selectedStatus.toLowerCase().replace('_', ' ');-->
<!--                statusChangeReason.value = '';-->
<!--                modal.show();-->
<!--            });-->
<!--        });-->

<!--        // Handle status change confirmation-->
<!--        confirmButton.addEventListener('click', function() {-->
<!--            if (!selectedStatus || !caseId) {-->
<!--                showAlert('Invalid case or status information.', 'error');-->
<!--                return;-->
<!--            }-->

<!--            // Show loading state-->
<!--            confirmButton.disabled = true;-->
<!--            confirmButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Updating...';-->

<!--            // Prepare request data-->
<!--            const requestData = {-->
<!--                caseId: caseId,-->
<!--                newStatus: selectedStatus,-->
<!--                reason: statusChangeReason.value.trim()-->
<!--            };-->

<!--            console.log('Sending request:', requestData); // Debug log-->
<!--            console.log('API URL:', `/api/v1/case-reports/${caseId}/status`); // Debug log-->

<!--            // Make API call to update status-->
<!--            fetch(`/api/v1/case-reports/${caseId}/status`, {-->
<!--                method: 'PUT',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json',-->
<!--                    'X-Requested-With': 'XMLHttpRequest',-->
<!--                    'Accept': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify(requestData)-->
<!--            })-->
<!--                .then(response => {-->
<!--                    console.log('Response status:', response.status); // Debug log-->
<!--                    if (!response.ok) {-->
<!--                        return response.text().then(text => {-->
<!--                            throw new Error(`HTTP ${response.status}: ${text}`);-->
<!--                        });-->
<!--                    }-->
<!--                    return response.json();-->
<!--                })-->
<!--                .then(data => {-->
<!--                    console.log('Success response:', data); // Debug log-->

<!--                    // Update the status badge-->
<!--                    updateStatusBadge(selectedStatus);-->

<!--                    // Hide modal and show success message-->
<!--                    modal.hide();-->
<!--                    showAlert('Case status updated successfully to ' + selectedStatus.toLowerCase().replace('_', ' ') + '.', 'success');-->

<!--                    // Optional: Reload page to refresh all status-dependent elements-->
<!--                    // setTimeout(() => window.location.reload(), 1500);-->
<!--                })-->
<!--                .catch(error => {-->
<!--                    console.error('Error updating case status:', error);-->
<!--                    showAlert('Failed to update case status: ' + error.message, 'error');-->
<!--                })-->
<!--                .finally(() => {-->
<!--                    // Reset button state-->
<!--                    confirmButton.disabled = false;-->
<!--                    confirmButton.innerHTML = 'Confirm Change';-->
<!--                });-->
<!--        });-->

<!--        // Function to update status badge-->
<!--        function updateStatusBadge(newStatus) {-->
<!--            statusBadge.textContent = newStatus.replace('_', ' ');-->

<!--            // Remove old status classes-->
<!--            statusBadge.className = statusBadge.className.replace(/status-\w+/g, '');-->

<!--            // Add new status class-->
<!--            statusBadge.classList.add('status-' + newStatus);-->
<!--        }-->

<!--        // Function to show alerts-->
<!--        function showAlert(message, type) {-->
<!--            // Remove any existing alerts first-->
<!--            const existingAlerts = document.querySelectorAll('.alert');-->
<!--            existingAlerts.forEach(alert => alert.remove());-->

<!--            // Create alert element-->
<!--            const alertDiv = document.createElement('div');-->
<!--            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;-->
<!--            alertDiv.innerHTML = `-->
<!--            ${message}-->
<!--            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>-->
<!--        `;-->

<!--            // Insert alert at the top of the card-->
<!--            const cardBody = document.querySelector('.case-info-card .card-body');-->
<!--            if (cardBody) {-->
<!--                cardBody.insertBefore(alertDiv, cardBody.firstChild);-->
<!--            } else {-->
<!--                // Fallback: insert at top of body-->
<!--                document.body.insertBefore(alertDiv, document.body.firstChild);-->
<!--            }-->

<!--            // Auto-dismiss after 5 seconds-->
<!--            setTimeout(() => {-->
<!--                if (alertDiv && alertDiv.parentNode) {-->
<!--                    alertDiv.remove();-->
<!--                }-->
<!--            }, 5000);-->
<!--        }-->
<!--    });-->
<!--</script>-->

<!--<style>-->
<!--    /* Status badge styling */-->
<!--    .status-badge {-->
<!--        padding: 0.375rem 0.75rem;-->
<!--        border-radius: 0.25rem;-->
<!--        font-size: 0.875rem;-->
<!--        font-weight: 500;-->
<!--        text-transform: uppercase;-->
<!--    }-->

<!--    .status-REPORTED {-->
<!--        background-color: #e3f2fd;-->
<!--        color: #1565c0;-->
<!--        border: 1px solid #bbdefb;-->
<!--    }-->

<!--    .status-ASSIGNED {-->
<!--        background-color: #fff3e0;-->
<!--        color: #ef6c00;-->
<!--        border: 1px solid #ffcc02;-->
<!--    }-->

<!--    .status-INVESTIGATING {-->
<!--        background-color: #f3e5f5;-->
<!--        color: #7b1fa2;-->
<!--        border: 1px solid #ce93d8;-->
<!--    }-->

<!--    .status-RESOLVED {-->
<!--        background-color: #e8f5e8;-->
<!--        color: #2e7d32;-->
<!--        border: 1px solid #a5d6a7;-->
<!--    }-->

<!--    .status-CLOSED {-->
<!--        background-color: #fafafa;-->
<!--        color: #616161;-->
<!--        border: 1px solid #e0e0e0;-->
<!--    }-->

<!--    /* Dropdown customization */-->
<!--    .dropdown-toggle::after {-->
<!--        margin-left: 0.5rem;-->
<!--    }-->

<!--    .dropdown-item:hover {-->
<!--        background-color: #f8f9fa;-->
<!--    }-->

<!--    /* Loading spinner */-->
<!--    .spinner-border-sm {-->
<!--        width: 0.875rem;-->
<!--        height: 0.875rem;-->
<!--    }-->
<!--</style>-->


<div class="card case-info-card mb-4" th:fragment="case-header(caseReport)">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h2 class="h4">Case #<span th:text="${caseReport.caseId}">CP-2024-0573</span></h2>
                <p class="text-muted mb-0">Reported on: <span th:text="${caseReport.reportDate}">June 3, 2024 at 14:23</span></p>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="d-flex align-items-center justify-content-md-end">
                    <span class="status-badge me-2" th:classappend="'status-' + ${caseReport.status}" th:text="${caseReport.status}">Under Investigation</span>

                    <!-- Status Change Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                                id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Change Status
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                            <li><button class="dropdown-item status-option" type="button" data-status="REPORTED">Reported</button></li>
                            <li><button class="dropdown-item status-option" type="button" data-status="ASSIGNED">Assigned</button></li>
                            <li><button class="dropdown-item status-option" type="button" data-status="INVESTIGATING">Investigating</button></li>
                            <li><button class="dropdown-item status-option" type="button" data-status="RESOLVED">Resolved</button></li>
                            <li><button class="dropdown-item status-option" type="button" data-status="CLOSED">Closed</button></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-4">
            </div>
            <div class="col-md-4">
                <p class="mb-1"><strong>Location:</strong> <span th:text="${caseReport.locationOfIncident}">1234 Oak Street, Springfield</span></p>
            </div>
        </div>
    </div>
</div>

<!-- Status Change Modal for Confirmation -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Confirm Status Change</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the status of Case #<span id="modalCaseId"></span> to <strong id="modalNewStatus"></strong>?</p>
                <div class="mb-3">
                    <label for="statusChangeReason" class="form-label">Reason for status change (optional):</label>
                    <textarea class="form-control" id="statusChangeReason" rows="3" placeholder="Enter reason for status change..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">Confirm Change</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing status change...');

        // Wait a bit for Thymeleaf to render
        setTimeout(function() {
            initializeStatusChange();
        }, 100);
    });

    function initializeStatusChange() {
        console.log('Initializing status change functionality...');

        const statusOptions = document.querySelectorAll('.status-option');
        const statusBadge = document.querySelector('.status-badge');
        const confirmButton = document.getElementById('confirmStatusChange');
        const modalCaseId = document.getElementById('modalCaseId');
        const modalNewStatus = document.getElementById('modalNewStatus');
        const statusChangeReason = document.getElementById('statusChangeReason');

        console.log('Found elements:', {
            statusOptions: statusOptions.length,
            statusBadge: !!statusBadge,
            confirmButton: !!confirmButton
        });

        let selectedStatus = '';
        let caseId = '';
        let modal = null;

        // Initialize Bootstrap modal
        try {
            modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
        } catch (e) {
            console.error('Bootstrap modal initialization failed:', e);
            return;
        }

        // Extract case ID from the page
        const caseIdElement = document.querySelector('h2.h4 span');
        if (caseIdElement) {
            caseId = caseIdElement.textContent.trim();
            console.log('Extracted case ID:', caseId);
        } else {
            console.error('Could not find case ID element');
            // Try to extract from URL as fallback
            const urlMatch = window.location.pathname.match(/\/(\w+)$/);
            if (urlMatch) {
                caseId = urlMatch[1];
                console.log('Extracted case ID from URL:', caseId);
            }
        }

        // Handle status option clicks
        statusOptions.forEach((option, index) => {
            console.log(`Attaching event to option ${index}:`, option.dataset.status);

            option.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                console.log('Status option clicked:', this.dataset.status);

                selectedStatus = this.dataset.status;
                const currentStatus = statusBadge ? statusBadge.textContent.trim().toUpperCase() : '';

                console.log('Selected:', selectedStatus, 'Current:', currentStatus);

                // Don't allow changing to the same status
                if (selectedStatus === currentStatus) {
                    showAlert('Case is already in ' + selectedStatus.toLowerCase() + ' status.', 'warning');
                    return;
                }

                // Validate we have a case ID
                if (!caseId) {
                    showAlert('Unable to determine case ID. Please refresh the page and try again.', 'error');
                    return;
                }

                // Show confirmation modal
                if (modalCaseId) modalCaseId.textContent = caseId;
                if (modalNewStatus) modalNewStatus.textContent = selectedStatus.toLowerCase();
                if (statusChangeReason) statusChangeReason.value = '';

                if (modal) {
                    modal.show();
                } else {
                    console.error('Modal not initialized');
                }
            });
        });

        // Handle status change confirmation
        if (confirmButton) {
            confirmButton.addEventListener('click', function() {
                console.log('Confirm button clicked, processing...');

                if (!selectedStatus || !caseId) {
                    console.error('Missing data:', { selectedStatus, caseId });
                    showAlert('Invalid case or status information.', 'error');
                    return;
                }

                // Show loading state
                confirmButton.disabled = true;
                confirmButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Updating...';

                // Prepare request data
                const requestData = {
                    caseId: caseId,
                    newStatus: selectedStatus,
                    reason: statusChangeReason ? statusChangeReason.value.trim() : ''
                };

                console.log('Sending request:', requestData);
                const apiUrl = `/api/v1/case-reports/${caseId}/status`;
                console.log('API URL:', apiUrl);

                // Make API call to update status
                fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                    .then(response => {
                        console.log('Response received:', response.status, response.statusText);

                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error('Error response body:', text);
                                throw new Error(`HTTP ${response.status}: ${text}`);
                            });
                        }

                        return response.json();
                    })
                    .then(data => {
                        console.log('Success response:', data);

                        // Update the status badge
                        updateStatusBadge(selectedStatus);

                        // Hide modal and show success message
                        if (modal) modal.hide();
                        showAlert('Case status updated successfully to ' + selectedStatus.toLowerCase() + '.', 'success');
                    })
                    .catch(error => {
                        console.error('API Error:', error);
                        showAlert('Failed to update case status: ' + error.message, 'error');
                    })
                    .finally(() => {
                        // Reset button state
                        confirmButton.disabled = false;
                        confirmButton.innerHTML = 'Confirm Change';
                    });
            });
        }

        // Function to update status badge
        function updateStatusBadge(newStatus) {
            if (!statusBadge) return;

            console.log('Updating status badge to:', newStatus);

            statusBadge.textContent = newStatus;

            // Remove old status classes
            statusBadge.className = statusBadge.className.replace(/status-\w+/g, '');

            // Add new status class
            statusBadge.classList.add('status-' + newStatus);
        }

        // Function to show alerts
        function showAlert(message, type) {
            console.log('Showing alert:', type, message);

            // Remove any existing alerts first
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

            // Insert alert at the top of the card
            const cardBody = document.querySelector('.case-info-card .card-body');
            if (cardBody) {
                cardBody.insertBefore(alertDiv, cardBody.firstChild);
            } else {
                // Fallback: insert at top of body
                document.body.insertBefore(alertDiv, document.body.firstChild);
            }

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        console.log('Status change initialization complete');
    }
</script>

<style>
    /* Status badge styling */
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-REPORTED {
        background-color: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
    }

    .status-ASSIGNED {
        background-color: #fff3e0;
        color: #ef6c00;
        border: 1px solid #ffcc02;
    }

    .status-INVESTIGATING {
        background-color: #f3e5f5;
        color: #7b1fa2;
        border: 1px solid #ce93d8;
    }

    .status-RESOLVED {
        background-color: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }

    .status-CLOSED {
        background-color: #fafafa;
        color: #616161;
        border: 1px solid #e0e0e0;
    }

    /* Dropdown customization */
    .dropdown-toggle::after {
        margin-left: 0.5rem;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    /* Loading spinner */
    .spinner-border-sm {
        width: 0.875rem;
        height: 0.875rem;
    }
</style>